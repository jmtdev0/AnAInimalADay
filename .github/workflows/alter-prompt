name: Alter Prompt

on:
  schedule:
    - cron: '0 6 * * *' # Cada día a las 06:00 UTC
  workflow_dispatch:

jobs:
  update_animal_prompt:
    runs-on: ubuntu-latest

    steps:
      - name: Call Llama to get a new image prompt generator
        env:
          CLOUDFLARE_ACCESS_TOKEN: ${{ secrets.CLOUDFLARE_ACCESS_TOKEN }}
          CLOUDFLARE_USER_ID: ${{ secrets.CLOUDFLARE_USER_ID }}
        run: |
          RESPONSE=$(curl -s https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_USER_ID/ai/run/@cf/meta/llama-4-scout-17b-16e-instruct \
            -X POST \
            -H "Authorization: Bearer $CLOUDFLARE_ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "messages": [
                { "role": "system", "content": "You are a creative assistant." },
                { "role": "user", "content": "Give me a prompt to generate a non-existent animal. Be as imaginative and crazy as possible." }
              ]
            }')

          echo "Llama response: $RESPONSE"

          RAW_PROMPT=$(echo "$RESPONSE" | jq -r '.result.response')
          CLEAN_PROMPT=$(echo "$RAW_PROMPT" | tr -d '"' | tr -d "'")
          PROMPT_ESCAPED=$(printf '%s' "$CLEAN_PROMPT" | jq -aRs .)

          echo "CLEAN_PROMPT and PROMPT_ESCAPED prepared successfully."

          # Guardamos sólo la versión escapada para evitar errores
          echo "PROMPT_ESCAPED=$PROMPT_ESCAPED" >> $GITHUB_ENV

      - name: Update ANIMAL_PROMPT variable in GitHub repository
        env:
          YEEHAW_ALTER_ANIMAL_PROMPT_TOKEN: ${{ secrets.YEEHAW_ALTER_ANIMAL_PROMPT_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          curl --location --request PATCH "https://api.github.com/repos/jmtdev0/AnAInimalADay/actions/variables/ANIMAL_PROMPT" \
            --header 'Accept: application/vnd.github+json' \
            --header "Authorization: Bearer $YEEHAW_ALTER_ANIMAL_PROMPT_TOKEN" \
            --header 'X-GitHub-Api-Version: 2022-11-28' \
            --header 'Content-Type: application/json' \
            --data "{\"name\":\"ANIMAL_PROMPT\",\"value\":${PROMPT_ESCAPED}}"
